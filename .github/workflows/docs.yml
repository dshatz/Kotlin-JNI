name: Deploy Multi-Docs

on:
  push:
    branches: ["master"]
    paths:
      - 'doc/Writerside/**'
      - 'src/**' # Rebuild API if source code changes
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required to fetch tags for versioning

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Get latest tag
        id: vars
        run: |
          # Finds the latest tag, defaults to 'latest' if no tags are found
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "latest")
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Build Dokka (API Reference)
        run: ./gradlew dokkaHtml -PprojectVersion=${{ steps.vars.outputs.tag }}

      - name: Build Writerside (User Guide)
        uses: JetBrains/writerside-github-action@v4
        with:
          project-path: 'doc/Writerside'
          instance: 'Writerside/hi'
          artifact-name: 'web-help'
        env:
          # Injects the version into Writerside's %latest_version% variable (defined in v.list)
          INSTANCE_LATEST_VERSION: ${{ steps.vars.outputs.tag }}

      - name: Setup Staging Area
        run: |
          # Create a fresh staging directory
          mkdir -p staging/api
          
          cp -r artifacts/* staging/
          
          cp -r jni/build/dokka/html/* staging/api/

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: staging

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4